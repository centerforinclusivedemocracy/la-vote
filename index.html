<!DOCTYPE html> 
<html> 
<!-- Define Head section, with links and scripts for use in Body -->
<head> 
<meta charset="utf-8" /> 
<meta name="viewport" 
      content="width=device-width, initial-scale=1.0"> 
      
<!-- Get the leaflet CSS/JS sources -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Get our internal CSS file -->
<link rel="stylesheet" href="style.css">

<!-- Get the AJAX source -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="leaflet.ajax.min.js" type="text/javascript" ></script>

<!-- Get Bootstrap for CID loading spinners -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">    

<!-- Add jQuery -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- <Add FontAwesome Icons -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js" integrity="sha512-IkGU/uDhB9u9F8k+2OsA6XXoowIhOuQL1NTgNZHY1nkURnqEGlDZq3GsfmdJdKFe1k1zOc6YU2K7qY+hF9AodA==" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.css" />
<script src="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.js"></script>
<link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">

<!--Get Geocoder source-->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

</head> 

<body>

<!-- CID loading screen for webpage -->
<div id="loading" style="text-align:center;">
    <img id="loading-image" src="CID.png" alt="Loading..." style="text-align:center;"/>
    <h3 style="text-align:center;">Loading approximately 250,000 precinct polygons for Los Angeles County... please allow several seconds to load.</h3>
    <div class="spinner-border slow text-danger" style="width: 13rem; height: 13rem;" role="status">
        <span class="sr-only">Loading...</span>
        </div>
    <div class="spinner-border slow text-dark" style="width: 13rem; height: 13rem;" role="status">
    <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-border slow text-warning" style="width: 13rem; height: 13rem;" role="status">
    <span class="sr-only">Loading...</span>
    </div>
</div> 

<!-- jQuery to close CID loading screen when page has loaded -->
<script>
    $(window).load(function() {
        $('#loading').hide();
    });
</script> 

<!-- Specify the map and it's dimensions -->
<div id="map"></div> 

<!-- Load the precint/vote center GeoJSONs and enable JS code below  -->
<script type="text/javascript" src="la_precincts.geojson"></script>
<script type="text/javascript" src="vote_centers.geojson"></script>
<script type="text/javascript"> 

// Call the Leaflet JS functions
var map = L.map(
            "map",
            {
                center: [34.0, -118.3],
                crs: L.CRS.EPSG3857,
                zoom: 9,
                zoomControl: false,
                preferCanvas: true,
            }
        );
L.control.scale().addTo(map);
L.control.zoom({position: 'topright'}).addTo(map);
var tile_layer = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            {"attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 7, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
        ).addTo(map);


// Legend color pallette and function
function getColor(d) {
    return d > 90 ? '#081d58' :
        d > 80  ? '#253494' :
        d > 70  ? '#225ea8' :
        d > 60  ? '#1d91c0' :
        d > 50  ? '#41b6c4' :
        d > 40  ? '#7fcdbb' :
        d > 30   ? '#c7e9b4' :
        d > 20   ? '#edf8b1' :
        d > 10   ? '#ffffd9' :
                    '#C4CACF';
    }

function style(feature) {
    return {
        fillColor: getColor(feature.properties.pctvote),
        weight: 1,
        opacity: .25,
        color: '#4a4c4f',
        fillOpacity: 0.7
    };
}

// Create precint polygons
var polygons = L.geoJson(la, {
    style: style,
    onEachFeature: onEachFeature
}).addTo(map);

// // Hover tooltip code for precinct data - not used anymore but left here in case we need it later. Append to "var polygons" call
// .bindTooltip(function (layer) { 
//   return '<b>Precinct: </b>'+layer.feature.properties.precinct+
//   '<br><b>Total Registered Voters: </b>'+layer.feature.properties["Number of Active Voters"]+
//   '<br><b>Total Votes Cast: </b>'+layer.feature.properties["Total Votes"]+
//   '<br><b>Percent of Registered Voters Casting Ballots: </b>'+layer.feature.properties["Percent Votes Cast"]+
//   '<br><b>Percent of All Ballots Cast by Mail: </b>'+layer.feature.properties["Percent Mail"]+
//   '<br><b>Percent of All Ballots Cast by Drop Box: </b>'+layer.feature.properties["Percent Drop Box"]+
//   '<br><b>Percent of All Ballots Cast In-Person: </b>'+layer.feature.properties["Percent Poll"]
// }).addTo(map);

// Geocoder: plugin from https://github.com/perliedman/leaflet-control-geocoder
var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false,
    collapsed: false,
    position: 'topright',
    placeholder: 'Search for specific location...'
    })
    .on('markgeocode', function(e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
        ]);
        map.fitBounds(poly.getBounds());
    })
    .addTo(map);

// Swtich function for VC 4day/11day icons to show 
function vc_style(feature, latlng) {
    switch(feature.properties["Vote Center Type"]) {
        case "4 Day":
            var four_day = new L.divIcon({
                className: 'four',
                    html: "<div style='background-color:#575556;' class='marker-pin2'></div><i class='far fa-building awesome'>",
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
            return L.marker(latlng, {icon: four_day});
        case "11 Day":
            var eleven_day = new L.divIcon({
                className: 'eleven',
                    html: "<div style='background-color:#4838cc;' class='marker-pin'></div><i class='far fa-building awesome'>",
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
            return L.marker(latlng, {icon: eleven_day});              
        }       
};

// Create VC layer and add popups with info
var geojsonLayer = L.geoJson(vc, {
    pointToLayer: vc_style,
    onEachFeature: function (feature, layer) {
        layer.bindPopup('<b>Vote Center Location:</b>'+
        '<br>'+feature.properties["Address"]+
        '<br><b>Number of In-person Votes Cast</b>: '+feature.properties["Number of Votes Accepted"]);
    }
});

// Create layer control icon
var controlLayers = L.control.layers(null,null,{collapsed:false}).addTo(map);
// Add VC layer to layer control
controlLayers.addOverlay(geojsonLayer, ' View Vote Centers');

// Control that shows state info on hover
var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info');
    this.update();
    return this._div;
};

info.update = function (props) {
    this._div.innerHTML = 
        '<h5>LA County Ballot Data</h5>' +
        'Total Registered Voters in LA County: <span style="color:#800000";><b>'+la.features[la.features.length-1].properties["Number of Active Voters"]+'</span></b><br>'+
        'Total Votes Cast in LA County: <span style="color:#800000";><b>'+la.features[la.features.length-1].properties["Total Votes"]+'</span></b><br>'+
        'Percent of Registered Voters Casting Ballots: <span style="color:#800000";><b>'+la.features[la.features.length-1].properties["Percent Votes Cast"]+'</span></b><br>'+
        '<hr>'+
        '<h5>LA Precinct Ballot Data</h5>' + 
      (
        props ?
        'Precinct: '+'<span style="color:#004080";><b>'+props.precinct+'</b></span>'+ 
        '<br>Total Registered Voters: <span style="color:#004080";><b>'+props["Number of Active Voters"]+'</span></b>'+
        '<br>Total Votes Cast: <span style="color:#004080";><b>'+props["Total Votes"]+'</span></b>'+
        '<br>Percent of Registered Voters Casting Ballots: <span style="color:#004080";><b>'+props['Percent Votes Cast']+'</span></b>'+
        '<br>Percent of All Ballots Cast by Mail: <span style="color:#004080";><b>'+props["Percent Mail"]+'</span></b>'+
        '<br>Percent of All Ballots Cast by Drop Box: <span style="color:#004080";><b>'+props["Percent Drop Box"]+'</span></b>'+
        '<br>Percent of All Ballots Cast In-Person: <span style="color:#004080";><b>'+props["Percent Poll"]+'</span></b>'
        : 'Hover over a precinct to view data'
        );
};

function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
			weight: 2.5,
			color: '#666',
            opacity: .75,
			dashArray: '',
			fillOpacity: 0.2
		});

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }

    info.update(layer.feature.properties);
}

function resetHighlight(e) {
    polygons.resetStyle(e.target);
    info.update();
}

function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
}

info.addTo(map);

</script>

<!-- Divs for text / legend -->
  <body>
  
  <div id='infobox' class='infobox'
   style='position: absolute; z-index:9999; border:2px solid grey; width: 500px; background-color:rgba(255, 255, 255, 0.8);
  border-radius:6px; padding: 3px; font-size:14px; right: 15px; bottom: 20px;'
  >
       
  <div>
      <b>Data Source</b>: California Secretary of State VoteCal System. Data by race and ethnicity of all voters are not available from the VoteCal system.<br><hr>
      <i>The LA County Early Ballot Count Tool was developed by the <a href="https://cid.usc.edu/" style="color:Blue;" target="_blank" rel="noopener noreferrer"> USC Center for Inclusive Democracy</a> in partnership with the California Secretary of State's Office.</i>
  </div>
  </div>
   
  </body>    

  <body>
   
  <div id='maplegend' class='maplegend' 
      style='position: absolute; z-index:9999; border:2px solid grey; background-color:rgba(255, 255, 255, 0.8);
       border-radius:6px; padding: 2px; font-size:14px; right: 15px; bottom: 125px;'>
       
  <div class='legend-title'>Percent of Registered<br>Voters Casting Ballots</div>
  <div class='legend-scale'>
    <ul class='legend-labels'>
      <li><span style='background:#C4CACF;opacity:0.7;'></span> No Data</li>
      <li><span style='background:#ffffd9;opacity:0.7;'></span> &lt; 10% </li>
      <li><span style='background:#edf8b1;opacity:0.7;'></span> 10-20%</li>
      <li><span style='background:#c7e9b4;opacity:0.7;'></span> 20-30%</li>
      <li><span style='background:#7fcdbb;opacity:0.7;'></span> 30-40%</li>
      <li><span style='background:#41b6c4;opacity:0.7;'></span> 40-50%</li>
      <li><span style='background:#1d91c0;opacity:0.7;'></span> 50-60%</li>
      <li><span style='background:#225ea8;opacity:0.7;'></span> 60-70%</li>
      <li><span style='background:#253494;opacity:0.7;'></span> 70-80%</li>
      <li><span style='background:#081d58;opacity:0.7;'></span> > 90%</li>
  
    </ul>
  </div>
  </div>
   
  </body> 
  <body>
  
  <div id='maplegend' class='maplegend' 
      style='position: absolute; z-index:9999; border:2px solid grey; background-color:rgba(255, 255, 255, 0.8);
       border-radius:6px; padding-top: 0px; padding-bottom:1px; padding-right:10px; padding-left:10px; font-size:14px; 
       top: 20px; left: 20px;'>
       
  <div class='legend-title'> 
      <h3 align="center" style="font-size:20px"><b>Los Angeles County Early Ballot<br>Count by Precinct and Vote Center</b></h3>
      <h4 align="center" style="font-size:15px"><b>2020 General Election</b></h4>
      <h5 align="center"style="font-size:12px">Last Updated: 9:30 am on 10/27/2020</h5> 
  </div>
  </div>

  <a href="https://cid.usc.edu/" target="_blank" rel="noopener noreferrer">
    <img id="float_image" alt="float_image"
                    src="https://raw.githubusercontent.com/centerforinclusivedemocracy/la-vote/folium-map-final/CID3.png?token=AEH24OAXWBYTBNIU22O23VK7TIJYM"
                    style='position: absolute; z-index:9999; padding-top: 0px; padding-bottom:1px; padding-right:10px; padding-left:0px; font-size:14px; bottom: 30px; left: 1px;'>
        </img>
    </a>
   
  </body>
</script>
</body> 
</html> 